<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco 8 Regine con backtracking - Masterclass Edition</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --board-border: #34495e;
            --white-cell: #ecf0f1;
            --black-cell: #95a5a6;
            --unsafe-overlay: rgba(231, 76, 60, 0.25);
            --conflict-color: #c0392b;
            --hint-color: #27ae60;
            --progress-bg: #34495e;
            --progress-fill: #3498db;
            --progress-error: #e74c3c;
            --btn-reset: #e74c3c;
            --btn-help: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { margin: 0 0 10px 0; font-size: 1.8rem; letter-spacing: 1px; }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            max-width: 500px;
            width: 100%;
        }

        /* --- CONTROLLI --- */
        .controls {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }

        button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            transition: filter 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            max-width: 200px;
        }

        button:active { transform: translateY(2px); }
        button:hover { filter: brightness(1.1); }

        .btn-reset { background-color: var(--btn-reset); color: white; }
        .btn-help { background-color: var(--btn-help); color: #2c3e50; }

        /* --- BARRA DI PROGRESSO E STATO --- */
        .status-panel {
            width: 100%;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #bdc3c7;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .progress-track {
            width: 100%;
            height: 8px;
            background-color: var(--progress-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--progress-fill);
            width: 0%;
            transition: width 0.4s ease, background-color 0.3s;
        }

        .progress-bar.error { background-color: var(--progress-error); }

        .witty-comment {
            font-size: 0.95rem;
            color: #f1c40f;
            font-style: italic;
            min-height: 1.4em;
        }

        /* --- SCACCHIERA --- */
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* Responsive */
            grid-template-rows: repeat(8, 1fr);
            border: 8px solid var(--board-border);
            border-radius: 4px;
            user-select: none;
            background-color: var(--board-border);
            gap: 1px;
            width: 100%;
            aspect-ratio: 1 / 1; /* Mantiene quadrato */
            max-width: 450px;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(20px, 5vw, 36px); /* Dimensione font dinamica */
            cursor: pointer;
            position: relative;
            background-color: var(--white-cell);
            color: #2c3e50;
        }

        .cell.black { background-color: var(--black-cell); }

        /* Effetti Visivi */
        .cell.unsafe::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: var(--unsafe-overlay);
            z-index: 1;
            pointer-events: none;
        }

        .cell.conflict {
            background-color: var(--conflict-color) !important;
            color: white !important;
            animation: shake 0.4s;
            z-index: 2;
        }

        .cell.hint {
            border: 3px solid var(--hint-color);
            box-sizing: border-box;
            background-color: rgba(39, 174, 96, 0.3);
            z-index: 3;
        }

        .queen-marker {
            z-index: 5;
            position: relative;
            pointer-events: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

    </style>
</head>
<body>

    <div class="game-container">
        <h1>8 Regine</h1>
        
        <div class="controls">
            <button class="btn-reset" onclick="resetBoard()">üóëÔ∏è Ricomincia</button>
            <button class="btn-help" onclick="getOneStepHelp()">üí° Aiutami</button>
        </div>

        <div class="status-panel">
            <div class="progress-header">
                <span id="progressText">0/8 Regine</span>
                <span id="percentText">0%</span>
            </div>
            <div class="progress-track">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="wittyComment" class="witty-comment">Piazza la prima regina...</div>
        </div>

        <div id="board" class="board"></div>
    </div>

    <script>
        const N = 8;
        let queens = []; // {r, c}

        // Frasi simpatiche per ogni step (0 a 8)
        const comments = [
            "Tutto tace. La scacchiera attende.",        // 0
            "Ottimo inizio. Chi ben comincia...",       // 1
            "Due regine. Facile, vero?",                // 2
            "Tre regine. Lo spazio inizia a mancare.",  // 3
            "Quattro! Sei a met√† dell'opera.",          // 4
            "Cinque. Attento a dove metti i piedi.",    // 5
            "Sei. La tensione sale...",                 // 6
            "Sette! Manca solo il colpo finale!",       // 7
            "OTTO! SEI UN GENIO ASSOLUTO! üèÜ"           // 8
        ];

        function initGame() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            for (let r = 0; r < N; r++) {
                for (let c = 0; c < N; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell', (r + c) % 2 === 0 ? 'white' : 'black');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.onclick = () => toggleQueen(r, c);
                    boardEl.appendChild(cell);
                }
            }
            queens = [];
            updateBoardVisuals();
            updateProgress();
        }

        function toggleQueen(r, c) {
            const index = queens.findIndex(q => q.r === r && q.c === c);
            
            if (index >= 0) {
                queens.splice(index, 1);
            } else {
                // Rimuovi regina sulla stessa riga se esiste (migliora UX)
                const rowQueenIndex = queens.findIndex(q => q.r === r);
                if (rowQueenIndex >= 0) queens.splice(rowQueenIndex, 1);
                
                queens.push({r, c});
            }
            
            updateBoardVisuals();
            updateProgress();
        }

        function updateProgress() {
            const count = queens.length;
            const percent = Math.round((count / N) * 100);
            const isConflict = hasDirectConflicts();

            // Elementi DOM
            const bar = document.getElementById('progressBar');
            const txtCount = document.getElementById('progressText');
            const txtPercent = document.getElementById('percentText');
            const txtComment = document.getElementById('wittyComment');

            // Aggiorna testi
            txtCount.innerText = `${count}/${N} Regine`;
            txtPercent.innerText = `${percent}%`;
            
            // Larghezza barra
            bar.style.width = `${percent}%`;

            // Gestione errori e commenti
            if (isConflict) {
                bar.classList.add('error');
                txtComment.innerText = "‚ö†Ô∏è Ahi! C'√® un conflitto. Le regine litigano!";
                txtComment.style.color = "#e74c3c";
            } else {
                bar.classList.remove('error');
                txtComment.innerText = comments[count] || "";
                
                // Colore speciale per la vittoria
                if (count === N) {
                    txtComment.style.color = "#2ecc71"; // Verde vittoria
                    triggerConfettiConfetti(); // Opzionale: effetto vittoria visivo semplice
                } else {
                    txtComment.style.color = "#f1c40f"; // Giallo normale
                }
            }
        }

        function triggerConfettiConfetti() {
             // Semplice effetto visivo CSS sulla barra
             const bar = document.getElementById('progressBar');
             bar.style.backgroundColor = "#2ecc71";
        }

        function updateBoardVisuals() {
            const cells = document.querySelectorAll('.cell');
            
            // Reset classi
            cells.forEach(c => {
                c.innerHTML = '';
                c.classList.remove('unsafe', 'conflict', 'hint');
            });

            // Calcolo zone "unsafe" (minacciate)
            let attackedCells = new Set();
            queens.forEach(q => {
                for(let r=0; r<N; r++) {
                    for(let c=0; c<N; c++) {
                        if (r === q.r || c === q.c || Math.abs(r - q.r) === Math.abs(c - q.c)) {
                            attackedCells.add(`${r},${c}`); 
                        }
                    }
                }
            });

            // Applica unsafe
            attackedCells.forEach(key => {
                const [r, c] = key.split(',');
                const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
                if(cell) cell.classList.add('unsafe');
            });

            // Disegna Regine e gestisci conflitti specifici
            queens.forEach((q1, i) => {
                const cell = document.querySelector(`.cell[data-row='${q1.r}'][data-col='${q1.c}']`);
                const span = document.createElement('span');
                span.classList.add('queen-marker');
                span.innerText = '‚ôõ';
                cell.appendChild(span);

                let isConflict = false;
                queens.forEach((q2, j) => {
                    if (i !== j) {
                        if (q1.r === q2.r || q1.c === q2.c || Math.abs(q1.r - q2.r) === Math.abs(q1.c - q2.c)) {
                            isConflict = true;
                        }
                    }
                });

                if (isConflict) {
                    cell.classList.add('conflict');
                    cell.classList.remove('unsafe');
                } else {
                    cell.classList.remove('unsafe');
                }
            });
        }

        // --- Logica AI ---

        function hasDirectConflicts() {
            for(let i=0; i<queens.length; i++) {
                for(let j=i+1; j<queens.length; j++) {
                    let q1 = queens[i];
                    let q2 = queens[j];
                    if (q1.r === q2.r || q1.c === q2.c || Math.abs(q1.r - q2.r) === Math.abs(q1.c - q2.c)) return true;
                }
            }
            return false;
        }

        function getOneStepHelp() {
            // Se ci sono conflitti, ferma tutto
            if (hasDirectConflicts()) {
                document.getElementById('wittyComment').innerText = "‚ö†Ô∏è Risolvi prima i conflitti rossi!";
                return;
            }
            if (queens.length === N) return;

            const solution = solve(queens);

            if (solution) {
                // Piazza la prossima regina
                for (let r = 0; r < N; r++) {
                    if (!queens.some(q => q.r === r)) {
                        const correctCol = solution[r];
                        queens.push({r: r, c: correctCol});
                        updateBoardVisuals();
                        updateProgress();

                        // Evidenzia mossa
                        const cell = document.querySelector(`.cell[data-row='${r}'][data-col='${correctCol}']`);
                        if(cell) cell.classList.add('hint');
                        return;
                    }
                }
            } else {
                document.getElementById('wittyComment').innerText = "‚õî Nessuna soluzione da qui. Torna indietro.";
            }
        }

        function solve(currentQueens) {
            let board = new Array(N).fill(-1);
            for(let q of currentQueens) board[q.r] = q.c;

            function solveRecursive(row) {
                if (row === N) return true; 
                if (board[row] !== -1) return solveRecursive(row + 1);

                for (let col = 0; col < N; col++) {
                    if (isSafe(board, row, col)) {
                        board[row] = col;
                        if (solveRecursive(row + 1)) return true;
                        board[row] = -1; 
                    }
                }
                return false;
            }
            if (solveRecursive(0)) return board;
            return null;
        }

        function isSafe(board, row, col) {
            for (let i = 0; i < N; i++) {
                if (board[i] !== -1) {
                    let r = i, c = board[i];
                    if (c === col || Math.abs(row - r) === Math.abs(col - c)) return false;
                }
            }
            return true;
        }

        function resetBoard() {
            queens = [];
            document.getElementById('progressBar').style.backgroundColor = ""; // reset colore vittoria
            updateBoardVisuals();
            updateProgress();
        }

        initGame();

    </script>
</body>
</html>
